name: C合并缓存  # workflow名称

on:
  workflow_run:
    workflows:
      - "B检查缓存workflow执行完毕合并"  # 监听此workflow执行完毕后触发本workflow
    types:
      - completed                   # 仅在被监听workflow完成后触发
  workflow_dispatch:               # 支持手动触发

jobs:
  merge-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install zoneinfo || true
          pip install -r requirements.txt || true

      - name: Run merge cache script
        run: python scripts/C_merge_cache.py

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Pull latest changes before commit
        run: git pull --rebase --autostash origin main

      - name: Add and commit merged cache files
        run: |
          git add output/cache/total_cache.json output/cache/merge_record.json || true
          if ! git diff --cached --quiet; then
            git commit -m "自动合并缓存数据 $(date +'%Y-%m-%d %H:%M:%S')"
          else
            echo "无变动，跳过提交。"
            exit 0
          fi

      - name: Push changes with retry
        run: |
          MAX_RETRIES=3
          count=0
          until [ $count -ge $MAX_RETRIES ]
          do
            git push origin main && break
            count=$((count+1))
            echo "Push失败，重试第 $count 次..."
            sleep 5
          done
          if [ $count -eq $MAX_RETRIES ]; then
            echo "Push操作失败，达到最大重试次数 $MAX_RETRIES"
            exit 1
          fi
