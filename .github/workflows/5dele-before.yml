name: 5清除日前执行信息

on:
  schedule:
    - cron: '0 15 * * *'  # 每天 UTC 15:00（北京时间 23:00）
  workflow_dispatch:      # 支持手动触发

permissions:
  contents: write

jobs:
  delete_workflows:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Delete deep_validation and hash-chunk workflow files
        run: |
          FILES_SCAN=$(find .github/workflows -type f -name "*scan_chunk*.yml" -o -name "hash-chunk*.yml")
          if [ -z "$FILES_SCAN" ]; then
            echo "No matching workflow files found."
            exit 0
          fi
          echo "Deleting files:"
          echo "$FILES_SCAN"
          git rm $FILES_SCAN || echo "No files removed"

      - name: Commit and push changes
        env:
          PUSH_TOKEN: ${{ secrets.PUSH_TOKEN1 }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git commit -m "Delete scan_chunk and hash-chunk workflow files" || echo "No changes to commit"

          git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/${{ github.repository }}

          n=0
          until [ $n -ge 3 ]
          do
            git pull --rebase origin main
            git push origin HEAD:main && break
            n=$((n+1))
            echo "Push failed, retry $n..."
            sleep 5
          done


  delete_all_runs:
    needs: delete_workflows
    runs-on: ubuntu-latest

    steps:
      - name: Install jq and curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Delete workflow runs except keep latest for chunk workflows
        env:
          PUSH_TOKEN: ${{ secrets.PUSH_TOKEN1 }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          #!/bin/bash
          set -euo pipefail

          echo "OWNER=$OWNER, REPO=$REPO"

          PER_PAGE=100
          page=1
          declare -A latest_chunk_run_ids

          echo "Fetching all workflows..."
          workflows_response=$(curl -s -w "%{http_code}" -H "Authorization: token $PUSH_TOKEN" \
            "https://api.github.com/repos/$OWNER/$REPO/actions/workflows?per_page=100")

          http_code="${workflows_response: -3}"
          workflows_json="${workflows_response:0:-3}"

          echo "HTTP status for workflows list: $http_code"
          if [ "$http_code" -ne 200 ]; then
            echo "Error fetching workflows list, HTTP status $http_code"
            echo "Response body:"
            echo "$workflows_json"
            exit 1
          fi

          if ! echo "$workflows_json" | jq empty; then
            echo "Invalid JSON for workflows list."
            exit 1
          fi

          chunk_workflow_ids=$(echo "$workflows_json" | jq -r '.workflows[] | select(.name | test("hash-chunk")) | .id')

          echo "Fetching and processing workflow runs..."

          while : ; do
            echo "Fetching page $page of workflow runs..."
            runs_response=$(curl -s -w "%{http_code}" -H "Authorization: token $PUSH_TOKEN" \
              "https://api.github.com/repos/$OWNER/$REPO/actions/runs?per_page=$PER_PAGE&page=$page")

            http_code="${runs_response: -3}"
            runs_json="${runs_response:0:-3}"

            echo "HTTP status for workflow runs page $page: $http_code"
            if [ "$http_code" -ne 200 ]; then
              echo "Error fetching workflow runs page $page, HTTP status $http_code"
              echo "Response body:"
              echo "$runs_json"
              exit 1
            fi

            if ! echo "$runs_json" | jq empty; then
              echo "Invalid JSON for workflow runs page $page."
              exit 1
            fi

            run_count=$(echo "$runs_json" | jq '.workflow_runs | length')
            if [ "$run_count" -eq 0 ]; then
              echo "No more runs found, finished."
              break
            fi

            for row in $(echo "$runs_json" | jq -c '.workflow_runs[]'); do
              run_id=$(echo "$row" | jq -r '.id')
              workflow_id=$(echo "$row" | jq -r '.workflow_id')
              created_at=$(echo "$row" | jq -r '.created_at')

              if echo "$chunk_workflow_ids" | grep -q "$workflow_id"; then
                # chunk workflow，保留最新一条，其余删除
                if [[ -z "${latest_chunk_run_ids[$workflow_id]:-}" ]]; then
                  latest_chunk_run_ids[$workflow_id]="$run_id|$created_at"
                else
                  old_time=$(echo "${latest_chunk_run_ids[$workflow_id]}" | cut -d'|' -f2)
                  if [[ "$created_at" > "$old_time" ]]; then
                    old_run_id=$(echo "${latest_chunk_run_ids[$workflow_id]}" | cut -d'|' -f1)
                    echo "Deleting older chunk workflow run id: $old_run_id"
                    curl -X DELETE -H "Authorization: token $PUSH_TOKEN" \
                      "https://api.github.com/repos/$OWNER/$REPO/actions/runs/$old_run_id"
                    latest_chunk_run_ids[$workflow_id]="$run_id|$created_at"
                  else
                    echo "Deleting older chunk workflow run id: $run_id"
                    curl -X DELETE -H "Authorization: token $PUSH_TOKEN" \
                      "https://api.github.com/repos/$OWNER/$REPO/actions/runs/$run_id"
                  fi
                fi
              else
                # 非 chunk workflow，全部删除
                echo "Deleting non-chunk workflow run id: $run_id"
                curl -X DELETE -H "Authorization: token $PUSH_TOKEN" \
                  "https://api.github.com/repos/$OWNER/$REPO/actions/runs/$run_id"
              fi
            done

            ((page++))
          done

          echo "Kept latest runs for chunk workflows:"
          for workflow_id in "${!latest_chunk_run_ids[@]}"; do
            run_info=${latest_chunk_run_ids[$workflow_id]}
            run_id=${run_info%%|*}
            created_at=${run_info#*|}
            echo "Workflow ID: $workflow_id, kept run id: $run_id, created at: $created_at"
          done