name: hash-chunk-7-0811

on:
  schedule:
    - cron: '11 8 * * *'  # UTC时间，需换算为UTC时间（假设北京时间+8小时）
  workflow_dispatch:
    inputs:
      manual_count:
        description: 'Manual trigger count'
        required: false
        default: '0'

permissions:
  contents: write

jobs:
  run-cache:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install --quiet pillow tqdm

      - name: Run cache script
        run: |
          python scripts/B-1cache.py --input output/middle/chunk/chunk-7.csv --timepoint 0811 --chunk_id 7

      - name: Push cache changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add output/cache/chunk/20251115/
          git commit -m "Update cache for chunk-7.csv at 0811" || echo "No changes to commit"
          n=0
          until [ $n -ge 3 ]
          do
            git push origin HEAD:main && break
            n=$((n+1))
            echo "Push failed, retry $n..."
            sleep 5
          done
        env:
          GITHUB_TOKEN: ${{ secrets.PUSH_TOKEN1 }}

      - name: Self-delete workflow file
        run: |
          git rm .github/workflows/hash-chunk-7-0811.yml
          git commit -m "Self delete hash-chunk-7-0811.yml"
          n=0
          until [ $n -ge 3 ]
          do
            git push origin HEAD:main && break
            n=$((n+1))
            echo "Push failed, retry $n..."
            sleep 5
          done
        env:
          GITHUB_TOKEN: ${{ secrets.PUSH_TOKEN1 }}
